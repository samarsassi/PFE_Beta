<ng-template #conditionModal let-modal>
  <div class="modal-header">
    <h4 class="modal-title">Add Workflow Condition</h4>
    <button type="button" class="btn-close" (click)="modal.dismiss('Cross click')"></button>
  </div>

  <div class="modal-body">

    <!-- Existing conditions -->
    <div *ngIf="existingConditions.length > 0" class="mb-3">
      <h5>Existing Conditions</h5>
      <ul class="list-group">
        <li *ngFor="let cond of existingConditions"
            class="list-group-item d-flex justify-content-between align-items-center">
          <span>
            {{ cond.conditionName || 'Default Flow' }}
            (Flow: {{ cond.flowId }}, Expr: {{ cond.conditionExpression || 'â€”' }})
            <span *ngIf="cond.isDefault" class="badge bg-info ms-2">Default</span>
          </span>
          <span>
            <button class="btn btn-sm btn-primary me-2" (click)="editCondition(cond)">Edit</button>
            <button class="btn btn-sm btn-danger" (click)="deleteCondition(cond.id!)">Delete</button>
          </span>
        </li>
      </ul>
    </div>

    <div *ngIf="existingConditions.length === 0" class="mb-3">
      <p>No existing conditions for this gateway.</p>
    </div>

    <!-- Form -->
    <form [formGroup]="conditionForm" (ngSubmit)="saveCondition()">

      <div class="form-group">
        <label for="gatewayId">Gateway ID</label>
        <input type="text" id="gatewayId" formControlName="gatewayId" class="form-control" readonly>
      </div>

      <div class="form-group">
        <label for="flowId">Flow ID *</label>
        <select id="flowId" formControlName="flowId" class="form-control" required>
          <option value="">Select Flow</option>
          <option *ngFor="let flow of flows" [value]="flow">{{ flow }}</option>
        </select>
      </div>

      <!-- Default flow toggle -->
      <div class="form-group form-check mt-2">
        <input type="checkbox" id="isDefault" formControlName="isDefault" class="form-check-input">
        <label for="isDefault" class="form-check-label">Mark as Default Flow</label>
      </div>
      <small class="form-text text-muted">
        If checked, this flow will be used when no other conditions match.
      </small>

      <!-- Disable condition fields when isDefault is true -->
      <div class="form-group mt-3">
        <label for="conditionExpression">Condition Expression *</label>
        <input type="text"
               id="conditionExpression"
               formControlName="conditionExpression"
               class="form-control"
               [disabled]="conditionForm.get('isDefault')?.value"
               placeholder="e.g., ${cvScore >= 3}">
        <small class="form-text text-muted">Flowable expression using process variables</small>
      </div>

      <div class="form-group">
        <label for="conditionName">Condition Name *</label>
        <input type="text"
               id="conditionName"
               formControlName="conditionName"
               class="form-control"
               [disabled]="conditionForm.get('isDefault')?.value"
               placeholder="e.g., High Score - Send Challenge">
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="modal.dismiss('Cancel')">Cancel</button>
        <button type="submit" class="btn btn-primary" [disabled]="!conditionForm.valid">Save</button>
      </div>
    </form>
  </div>
</ng-template>
