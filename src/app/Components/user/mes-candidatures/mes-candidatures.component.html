<div class="mes-candidatures-container">
  <h1 class="dashboard-title">Mon tableau de bord</h1>
  <p class="dashboard-subtitle">Suivez vos candidatures et votre progression de carri√®re</p>

  <!-- KPI Cards Row -->
  <div class="kpi-cards-row">
    <div class="kpi-card kpi-apps">
      <div class="kpi-label">Candidatures totales</div>
      <div class="kpi-value">{{ candidatures.length }}</div>
      <span class="kpi-icon kpi-icon-apps">üóÇÔ∏è</span>
    </div>
    <div class="kpi-card kpi-review">
      <div class="kpi-label">En cours d'examen</div>
      <div class="kpi-value">{{ enAttenteCount }}</div>
      <span class="kpi-icon kpi-icon-review">üìä</span>
    </div>
    <div class="kpi-card kpi-interview">
      <div class="kpi-label">Entretiens</div>
      <div class="kpi-value"> </div>
      <span class="kpi-icon kpi-icon-interview">üóìÔ∏è</span>
    </div>
    <div class="kpi-card kpi-success">
      <div class="kpi-label">Taux de r√©ussite</div>
      <div class="kpi-value">{{ acceptedPercentage | number:'1.0-0' }}%</div>
      <span class="kpi-icon kpi-icon-success">üìà</span>
    </div>
  </div>

  <!-- Applications Card -->
  <div class="applications-card">
    <h2 class="section-title">Mes candidatures</h2>

    <div *ngIf="loading" class="loading">Chargement...</div>

    <div *ngIf="!loading && candidatures.length === 0" class="empty-state">
      <p>Vous n'avez pas encore de candidatures.</p>
    </div>

    <div *ngIf="!loading && !selectedCandidature && candidatures.length > 0">
      <div *ngFor="let c of candidatures" class="application-card" (click)="selectCandidature(c)">
        <div class="application-header pro"
          style="display: flex; justify-content: space-between; align-items: flex-start;">
          <div>
            <div class="application-offer-title pro highlight">{{ c.offreEmploi?.titre || 'Offre inconnue' }}</div>
            <div class="application-company pro">{{ c.email }}</div>
          </div>
          <div class="application-status pro">
            <span class="status-badge pro" [ngClass]="{
                'status-inreview': c.statut === 'EN ATTENTE',
                'status-accepted': c.statut === 'ACCEPT√â',
                'status-rejected': c.statut === 'REJET√â'
              }">
              <ng-container [ngSwitch]="c.statut">
                <span *ngSwitchCase="'EN ATTENTE'">En cours</span>
                <span *ngSwitchCase="'ACCEPT√â'">Accept√©e</span>
                <span *ngSwitchCase="'REJET√â'">Rejet√©e</span>
                <span *ngSwitchDefault>{{ c.statut }}</span>
              </ng-container>
            </span>
          </div>
        </div>

        <div class="application-footer pro"
          style="display: flex; justify-content: space-between; align-items: center; margin-top: 1.2rem;">
          <span class="application-dates pro">D√©pos√©e le : {{ c.dateCreation ? (c.dateCreation | date:'mediumDate') :
            'N/A' }}</span>
          <span class="application-update pro">Derni√®re mise √† jour : {{ c.dateModification ? (c.dateModification |
            date:'mediumDate') : (c.dateCreation ? (c.dateCreation | date:'mediumDate') : 'N/A') }}</span>
        </div>

        <div class="application-actions pro" style="display: flex; justify-content: flex-end; margin-top: 0.5rem;">
          <button class="btn btn-primary btn-small" (click)="$event.stopPropagation(); selectCandidature(c)">Voir la
            timeline</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Detail View (Timeline) -->
  <div *ngIf="!loading && selectedCandidature">
    <div class="timeline-header">
      <button class="btn-icon" (click)="clearSelected()">
        <mat-icon>arrow_back</mat-icon>
        Retour
      </button>
      <div class="candidate-info">
        <span class="candidate-name">{{ selectedCandidature.nom }}</span>
        <span class="status-badge" [ngClass]="{
          'badge-pending': selectedCandidature.statut === 'EN ATTENTE',
          'badge-accepted': selectedCandidature.statut === 'ACCEPT√â',
          'badge-rejected': selectedCandidature.statut === 'REJET√â'
        }">{{ selectedCandidature.statut }}</span>
      </div>
      <button class="btn-danger" (click)="confirmAndDeleteCandidature(selectedCandidature.id)">
        <mat-icon>delete</mat-icon>
        Supprimer
      </button>
    </div>

    <div class="timeline-container">
      <div class="timeline-step active">
        <div class="timeline-dot"></div>
        <div>
          <div class="timeline-title">Candidature d√©pos√©e</div>
          <div class="timeline-date">{{ selectedCandidature.dateCreation | date:'short' }}</div>
        </div>
      </div>
      <div class="timeline-step" [class.active]="selectedCandidature.statut === 'EN ATTENTE'">
        <div class="timeline-dot"></div>
        <div>
          <div class="timeline-title">En cours d'examen</div>
          <div class="timeline-date" *ngIf="selectedCandidature.statut === 'EN ATTENTE'">En cours</div>
        </div>
      </div>
      <div class="timeline-step" [class.active]="selectedCandidature.defiEnvoyeLe">
        <div class="timeline-dot"></div>
        <div>
          <div class="timeline-title">D√©fi envoy√©</div>
          <div class="timeline-date" *ngIf="selectedCandidature.defiEnvoyeLe">
            {{ selectedCandidature.defiEnvoyeLe | date:'short' }}
          </div>
          <button class="btn-primary" [routerLink]="['../code-executor', selectedCandidature.id]"
            [disabled]="selectedCandidature.statut === 'REJET√â'"
            matTooltip="Impossible d'acc√©der au d√©fi si la candidature est rejet√©e">
            Acc√©der au d√©fi
          </button>
        </div>
      </div>
      <div class="timeline-step" [class.active]="selectedCandidature.defiTermineLe">
        <div class="timeline-dot"></div>
        <div>
          <div class="timeline-title">D√©fi termin√©</div>
          <div class="timeline-date" *ngIf="selectedCandidature.defiTermineLe">
            {{ selectedCandidature.defiTermineLe | date:'short' }}
          </div>
        </div>
      </div>
      <div class="timeline-step" [class.active]="selectedCandidature.statutDefi === 'EVALUE'">
        <div class="timeline-dot"></div>
        <div>
          <div class="timeline-title">D√©fi √©valu√©</div>
          <div class="timeline-date" *ngIf="selectedCandidature.statutDefi === 'EVALUE'">√âvalu√©</div>
        </div>
      </div>
      <div class="timeline-step"
        [class.active]="selectedCandidature.statut === 'ACCEPT√â' || selectedCandidature.statut === 'REJET√â'">
        <div class="timeline-dot"></div>
        <div>
          <div class="timeline-title">D√©cision finale</div>
          <div class="timeline-date" *ngIf="selectedCandidature.statut === 'ACCEPT√â'">Accept√©e</div>
          <div class="timeline-date" *ngIf="selectedCandidature.statut === 'REJET√â'">Rejet√©e</div>
        </div>
      </div>
    </div>
  </div>
</div>